<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Widget Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #chat-container {
            width: 400px;
            height: 500px;
            border: 1px solid #ccc;
            margin: 20px 0;
        }
        button {
            margin: 5px;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üß™ Simple Widget Test</h1>
    
    <div>
        <button onclick="initWidget()">Initialize Widget</button>
        <button onclick="sendTest()">Send Test Message</button>
        <button onclick="destroyWidget()">Destroy Widget</button>
    </div>
    
    <div id="chat-container"></div>
    
    <div>
        <h3>Console Output:</h3>
        <div id="log" style="background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script src="dist/chatbot-widget.js"></script>
    <script>
        // Mock fetch to simulate backend
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (url.includes('chatbotbackend.com/chat')) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            ok: true,
                            json: () => Promise.resolve({
                                body: "Hello! This is a test response from the mock backend."
                            })
                        });
                    }, 1000);
                });
            }
            return originalFetch.apply(this, arguments);
        };

        // Enhanced logging
        function log(message) {
            console.log(message);
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Test functions
        function initWidget() {
            try {
                log('Attempting to initialize widget...');
                log('ChatbotWidget available: ' + (typeof ChatbotWidget));
                
                ChatbotWidget.init({
                    clientId: "simple-test",
                    container: "#chat-container",
                    theme: "light"
                });
                
                log('‚úÖ Widget initialized successfully!');
                
                // Debug: Check shadow DOM content
                setTimeout(() => {
                    const container = document.querySelector('#chat-container');
                    if (container && container.shadowRoot) {
                        log('‚úÖ Shadow DOM found');
                        log('Shadow DOM children: ' + container.shadowRoot.children.length);
                        log('Shadow DOM HTML length: ' + container.shadowRoot.innerHTML.length);
                        
                        // Check for specific elements
                        const widget = container.shadowRoot.querySelector('.chatbot-widget');
                        const header = container.shadowRoot.querySelector('.chatbot-widget__header');
                        const input = container.shadowRoot.querySelector('.chat-input');
                        
                        log('Widget element found: ' + !!widget);
                        log('Header element found: ' + !!header);
                        log('Input element found: ' + !!input);
                        
                        if (widget) {
                            log('Widget visibility: ' + window.getComputedStyle(widget).opacity);
                            log('Widget display: ' + window.getComputedStyle(widget).display);
                        }
                    } else {
                        log('‚ùå No shadow DOM found');
                    }
                }, 200);
                
            } catch (error) {
                log('‚ùå Error initializing widget: ' + error.message);
                console.error('Full error:', error);
            }
        }

        function sendTest() {
            try {
                log('Attempting to send test message...');
                ChatbotWidget.send("Hello! This is a test message.");
                log('‚úÖ Message sent successfully!');
            } catch (error) {
                log('‚ùå Error sending message: ' + error.message);
                console.error('Full error:', error);
            }
        }

        function destroyWidget() {
            try {
                log('Attempting to destroy widget...');
                ChatbotWidget.unmount();
                log('‚úÖ Widget destroyed successfully!');
            } catch (error) {
                log('‚ùå Error destroying widget: ' + error.message);
                console.error('Full error:', error);
            }
        }

        // Initialize logging
        window.addEventListener('load', () => {
            log('Page loaded successfully');
            log('ChatbotWidget type: ' + typeof ChatbotWidget);
            if (typeof ChatbotWidget === 'object') {
                log('ChatbotWidget methods: ' + Object.keys(ChatbotWidget).join(', '));
            }
        });

        // Catch any global errors
        window.addEventListener('error', (e) => {
            log('‚ùå Global error: ' + e.message);
            console.error('Global error details:', e);
        });
    </script>
</body>
</html>